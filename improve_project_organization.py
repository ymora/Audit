#!/usr/bin/env python3
"""
AM√âLIORATION DE L'ORGANISATION DES PROJETS - SYST√àME D'AUDIT UNIVERSEL
=====================================================================

Script pour am√©liorer l'organisation des projets et clarifier la distinction
entre les logs/rapports du programme et ceux de l'audit.
"""

import os
import shutil
from pathlib import Path
from datetime import datetime

class ProjectOrganizationImprover:
    def __init__(self, project_dir: Path):
        self.project_dir = project_dir
        
    def analyze_current_confusion(self):
        """Analyse la confusion actuelle dans l'organisation des projets."""
        print("üîç Analyse de la confusion actuelle...")
        
        issues = []
        projects_dir = self.project_dir / "projects"
        
        if projects_dir.exists():
            for project_path in projects_dir.iterdir():
                if project_path.is_dir():
                    project_name = project_path.name
                    
                    # V√©rifier la confusion logs
                    project_logs = project_path / "logs"
                    audit_logs = project_path / ".project" / "logs"
                    
                    if project_logs.exists() and audit_logs.exists():
                        issues.append(f"‚ö†Ô∏è {project_name}: Confusion entre logs du programme et logs d'audit")
                    
                    # V√©rifier la confusion reports
                    project_reports = project_path / "reports"
                    audit_reports = project_path / ".project" / "reports"
                    
                    if project_reports.exists() and audit_reports.exists():
                        issues.append(f"‚ö†Ô∏è {project_name}: Confusion entre rapports du programme et rapports d'audit")
                    
                    # V√©rifier la confusion tests
                    project_tests = project_path / "tests"
                    audit_tests = project_path / ".project" / "tests"
                    
                    if project_tests.exists() and audit_tests.exists():
                        issues.append(f"‚ö†Ô∏è {project_name}: Confusion entre tests du programme et tests d'audit")
        
        if issues:
            print("   Probl√®mes identifi√©s:")
            for issue in issues:
                print(f"      {issue}")
        else:
            print("   ‚úÖ Organisation actuelle claire")
        
        return issues
    
    def propose_clear_organization(self):
        """Propose une organisation claire et simple."""
        print("\nüéØ Organisation claire propos√©e:")
        print("""
PROJET TYPIQUE (ex: docusense_ai)
=================================

docusense_ai/
‚îú‚îÄ‚îÄ config.json              # Configuration du projet
‚îú‚îÄ‚îÄ src/                     # Code source du projet
‚îú‚îÄ‚îÄ tests/                   # Tests du projet (fonctionnels, unitaires)
‚îú‚îÄ‚îÄ logs/                    # Logs du programme en cours d'ex√©cution
‚îú‚îÄ‚îÄ reports/                 # Rapports g√©n√©r√©s par le programme
‚îú‚îÄ‚îÄ docs/                    # Documentation du projet
‚îî‚îÄ‚îÄ .project/                  # Dossier d'audit (cach√©)
    ‚îú‚îÄ‚îÄ config/              # Configuration sp√©cifique √† l'audit
    ‚îÇ   ‚îî‚îÄ‚îÄ project_config.json
    ‚îú‚îÄ‚îÄ logs/                # Logs des sessions d'audit
    ‚îú‚îÄ‚îÄ reports/             # Rapports d'audit g√©n√©r√©s
    ‚îî‚îÄ‚îÄ tests/               # Tests sp√©cifiques √† l'audit (optionnel)

AVANTAGES DE CETTE ORGANISATION:
===============================

1. üìÅ S√âPARATION CLAIRE :
   - logs/ = Logs du programme en cours d'ex√©cution
   - .project/logs/ = Logs des sessions d'audit

2. üìã DISTINCTION √âVIDENTE :
   - reports/ = Rapports g√©n√©r√©s par le programme
   - .project/reports/ = Rapports d'audit

3. üß™ TESTS ORGANIS√âS :
   - tests/ = Tests du projet (fonctionnels, unitaires)
   - .project/tests/ = Tests sp√©cifiques √† l'audit (optionnel)

4. üéØ SIMPLICIT√â :
   - Structure pr√©visible
   - Pas de confusion possible
   - Facile √† comprendre
        """)
    
    def reorganize_projects(self):
        """R√©organise les projets pour clarifier la structure."""
        print("\nüîÑ R√©organisation des projets...")
        
        projects_dir = self.project_dir / "projects"
        
        if projects_dir.exists():
            for project_path in projects_dir.iterdir():
                if project_path.is_dir():
                    project_name = project_path.name
                    print(f"   üìÅ R√©organisation de {project_name}...")
                    
                    # 1. Clarifier les logs
                    self._clarify_logs(project_path, project_name)
                    
                    # 2. Clarifier les rapports
                    self._clarify_reports(project_path, project_name)
                    
                    # 3. Clarifier les tests
                    self._clarify_tests(project_path, project_name)
                    
                    # 4. Cr√©er la structure claire
                    self._create_clear_structure(project_path, project_name)
    
    def _clarify_logs(self, project_path: Path, project_name: str):
        """Clarifie l'organisation des logs."""
        project_logs = project_path / "logs"
        audit_logs = project_path / ".project" / "logs"
        
        if project_logs.exists() and audit_logs.exists():
            print(f"      üìù Clarification des logs pour {project_name}")
            
            # Cr√©er un dossier temporaire pour trier
            temp_logs = project_path / "temp_logs"
            temp_logs.mkdir(exist_ok=True)
            
            # D√©placer tous les logs dans le temporaire
            for log_file in project_logs.glob("*"):
                if log_file.is_file():
                    shutil.move(str(log_file), str(temp_logs / log_file.name))
            
            for log_file in audit_logs.glob("*"):
                if log_file.is_file():
                    shutil.move(str(log_file), str(temp_logs / log_file.name))
            
            # Supprimer les dossiers vides
            if not any(project_logs.iterdir()):
                project_logs.rmdir()
            if not any(audit_logs.iterdir()):
                audit_logs.rmdir()
            
            # Recr√©er les dossiers
            project_logs.mkdir(exist_ok=True)
            audit_logs.mkdir(parents=True, exist_ok=True)
            
            # Trier les logs par nom de fichier
            for log_file in temp_logs.glob("*"):
                if log_file.is_file():
                    filename = log_file.name.lower()
                    
                    # Logs d'audit contiennent "audit" dans le nom
                    if "audit" in filename or "session" in filename:
                        shutil.move(str(log_file), str(audit_logs / log_file.name))
                    else:
                        # Logs du programme
                        shutil.move(str(log_file), str(project_logs / log_file.name))
            
            # Supprimer le dossier temporaire
            if temp_logs.exists():
                temp_logs.rmdir()
    
    def _clarify_reports(self, project_path: Path, project_name: str):
        """Clarifie l'organisation des rapports."""
        project_reports = project_path / "reports"
        audit_reports = project_path / ".project" / "reports"
        
        if project_reports.exists() and audit_reports.exists():
            print(f"      üìã Clarification des rapports pour {project_name}")
            
            # Cr√©er un dossier temporaire pour trier
            temp_reports = project_path / "temp_reports"
            temp_reports.mkdir(exist_ok=True)
            
            # D√©placer tous les rapports dans le temporaire
            for report_file in project_reports.glob("*"):
                if report_file.is_file():
                    shutil.move(str(report_file), str(temp_reports / report_file.name))
            
            for report_file in audit_reports.glob("*"):
                if report_file.is_file():
                    shutil.move(str(report_file), str(temp_reports / report_file.name))
            
            # Supprimer les dossiers vides
            if not any(project_reports.iterdir()):
                project_reports.rmdir()
            if not any(audit_reports.iterdir()):
                audit_reports.rmdir()
            
            # Recr√©er les dossiers
            project_reports.mkdir(exist_ok=True)
            audit_reports.mkdir(parents=True, exist_ok=True)
            
            # Trier les rapports par nom de fichier
            for report_file in temp_reports.glob("*"):
                if report_file.is_file():
                    filename = report_file.name.lower()
                    
                    # Rapports d'audit contiennent "audit" dans le nom
                    if "audit" in filename or "report" in filename:
                        shutil.move(str(report_file), str(audit_reports / report_file.name))
                    else:
                        # Rapports du programme
                        shutil.move(str(report_file), str(project_reports / report_file.name))
            
            # Supprimer le dossier temporaire
            if temp_reports.exists():
                temp_reports.rmdir()
    
    def _clarify_tests(self, project_path: Path, project_name: str):
        """Clarifie l'organisation des tests."""
        project_tests = project_path / "tests"
        audit_tests = project_path / ".project" / "tests"
        
        if project_tests.exists() and audit_tests.exists():
            print(f"      üß™ Clarification des tests pour {project_name}")
            
            # Cr√©er un dossier temporaire pour trier
            temp_tests = project_path / "temp_tests"
            temp_tests.mkdir(exist_ok=True)
            
            # D√©placer tous les tests dans le temporaire
            for test_file in project_tests.glob("*"):
                if test_file.is_file():
                    shutil.move(str(test_file), str(temp_tests / test_file.name))
            
            for test_file in audit_tests.glob("*"):
                if test_file.is_file():
                    shutil.move(str(test_file), str(temp_tests / test_file.name))
            
            # Supprimer les dossiers vides
            if not any(project_tests.iterdir()):
                project_tests.rmdir()
            if not any(audit_tests.iterdir()):
                audit_tests.rmdir()
            
            # Recr√©er les dossiers
            project_tests.mkdir(exist_ok=True)
            audit_tests.mkdir(parents=True, exist_ok=True)
            
            # Trier les tests par nom de fichier
            for test_file in temp_tests.glob("*"):
                if test_file.is_file():
                    filename = test_file.name.lower()
                    
                    # Tests d'audit contiennent "audit" dans le nom
                    if "audit" in filename or "security" in filename:
                        shutil.move(str(test_file), str(audit_tests / test_file.name))
                    else:
                        # Tests du programme
                        shutil.move(str(test_file), str(project_tests / test_file.name))
            
            # Supprimer le dossier temporaire
            if temp_tests.exists():
                temp_tests.rmdir()
    
    def _create_clear_structure(self, project_path: Path, project_name: str):
        """Cr√©e une structure claire avec des fichiers README explicatifs."""
        print(f"      üìÑ Cr√©ation de la documentation pour {project_name}")
        
        # Cr√©er README pour les logs du programme
        project_logs = project_path / "logs"
        if project_logs.exists():
            logs_readme = project_logs / "README.md"
            logs_content = f"""# Logs du Programme - {project_name}

Ce dossier contient les logs g√©n√©r√©s par le programme {project_name} en cours d'ex√©cution.

## Contenu typique :
- Logs d'application
- Logs d'erreurs
- Logs de performance
- Logs de d√©bogage

## Utilisation :
Ces logs sont g√©n√©r√©s automatiquement par le programme lors de son ex√©cution.
"""
            with open(logs_readme, 'w', encoding='utf-8') as f:
                f.write(logs_content)
        
        # Cr√©er README pour les rapports du programme
        project_reports = project_path / "reports"
        if project_reports.exists():
            reports_readme = project_reports / "README.md"
            reports_content = f"""# Rapports du Programme - {project_name}

Ce dossier contient les rapports g√©n√©r√©s par le programme {project_name}.

## Contenu typique :
- Rapports de performance
- Rapports d'utilisation
- Rapports d'erreurs
- Statistiques du programme

## Utilisation :
Ces rapports sont g√©n√©r√©s par le programme lui-m√™me, pas par l'audit.
"""
            with open(reports_readme, 'w', encoding='utf-8') as f:
                f.write(reports_content)
        
        # Cr√©er README pour les tests du programme
        project_tests = project_path / "tests"
        if project_tests.exists():
            tests_readme = project_tests / "README.md"
            tests_content = f"""# Tests du Programme - {project_name}

Ce dossier contient les tests du programme {project_name}.

## Contenu typique :
- Tests unitaires
- Tests d'int√©gration
- Tests fonctionnels
- Tests de performance

## Utilisation :
Ces tests v√©rifient le bon fonctionnement du programme.
"""
            with open(tests_readme, 'w', encoding='utf-8') as f:
                f.write(tests_content)
        
        # Cr√©er README pour le dossier .project
        audit_dir = project_path / ".project"
        if audit_dir.exists():
            audit_readme = audit_dir / "README.md"
            audit_content = f"""# Dossier d'Audit - {project_name}

Ce dossier contient tous les √©l√©ments sp√©cifiques √† l'audit du projet {project_name}.

## Structure :
- `config/` : Configuration sp√©cifique √† l'audit
- `logs/` : Logs des sessions d'audit
- `reports/` : Rapports d'audit g√©n√©r√©s
- `tests/` : Tests sp√©cifiques √† l'audit (optionnel)

## Distinction importante :
- Les logs/rapports du PROGRAMME sont dans les dossiers √† la racine
- Les logs/rapports d'AUDIT sont dans ce dossier .project/

## Utilisation :
Ce dossier est g√©r√© automatiquement par le syst√®me d'audit.
"""
            with open(audit_readme, 'w', encoding='utf-8') as f:
                f.write(audit_content)
    
    def verify_improvement(self):
        """V√©rifie que l'am√©lioration s'est bien pass√©e."""
        print("\n‚úÖ V√©rification de l'am√©lioration...")
        
        projects_dir = self.project_dir / "projects"
        
        if projects_dir.exists():
            for project_path in projects_dir.iterdir():
                if project_path.is_dir():
                    project_name = project_path.name
                    
                    # V√©rifier la structure claire
                    project_logs = project_path / "logs"
                    audit_logs = project_path / ".project" / "logs"
                    project_reports = project_path / "reports"
                    audit_reports = project_path / ".project" / "reports"
                    
                    if project_logs.exists() and audit_logs.exists():
                        print(f"   ‚úÖ {project_name}: Logs s√©par√©s (programme vs audit)")
                    
                    if project_reports.exists() and audit_reports.exists():
                        print(f"   ‚úÖ {project_name}: Rapports s√©par√©s (programme vs audit)")
                    
                    # V√©rifier les README
                    if (project_logs / "README.md").exists():
                        print(f"   ‚úÖ {project_name}: Documentation des logs cr√©√©e")
                    
                    if (project_reports / "README.md").exists():
                        print(f"   ‚úÖ {project_name}: Documentation des rapports cr√©√©e")
    
    def generate_organization_guide(self):
        """G√©n√®re un guide d'organisation pour les projets."""
        print("\nüìã G√©n√©ration du guide d'organisation...")
        
        guide_content = f"""# GUIDE D'ORGANISATION DES PROJETS
Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## Structure claire recommand√©e pour chaque projet

```
projet_exemple/
‚îú‚îÄ‚îÄ config.json              # Configuration du projet
‚îú‚îÄ‚îÄ src/                     # Code source du projet
‚îú‚îÄ‚îÄ tests/                   # Tests du projet (fonctionnels, unitaires)
‚îÇ   ‚îî‚îÄ‚îÄ README.md           # Documentation des tests
‚îú‚îÄ‚îÄ logs/                    # Logs du programme en cours d'ex√©cution
‚îÇ   ‚îî‚îÄ‚îÄ README.md           # Documentation des logs
‚îú‚îÄ‚îÄ reports/                 # Rapports g√©n√©r√©s par le programme
‚îÇ   ‚îî‚îÄ‚îÄ README.md           # Documentation des rapports
‚îú‚îÄ‚îÄ docs/                    # Documentation du projet
‚îî‚îÄ‚îÄ .project/                  # Dossier d'audit (cach√©)
    ‚îú‚îÄ‚îÄ README.md           # Documentation de l'audit
    ‚îú‚îÄ‚îÄ config/              # Configuration sp√©cifique √† l'audit
    ‚îú‚îÄ‚îÄ logs/                # Logs des sessions d'audit
    ‚îú‚îÄ‚îÄ reports/             # Rapports d'audit g√©n√©r√©s
    ‚îî‚îÄ‚îÄ tests/               # Tests sp√©cifiques √† l'audit (optionnel)
```

## Distinctions importantes

### üìù Logs
- **logs/** : Logs du programme en cours d'ex√©cution
- **.project/logs/** : Logs des sessions d'audit

### üìã Rapports
- **reports/** : Rapports g√©n√©r√©s par le programme
- **.project/reports/** : Rapports d'audit g√©n√©r√©s

### üß™ Tests
- **tests/** : Tests du projet (fonctionnels, unitaires)
- **.project/tests/** : Tests sp√©cifiques √† l'audit (optionnel)

## Avantages

1. **Clart√©** : Pas de confusion possible
2. **Simplicit√©** : Structure pr√©visible
3. **Documentation** : README explicatifs dans chaque dossier
4. **S√©paration** : Programme et audit bien distincts
5. **Maintenabilit√©** : Organisation logique et coh√©rente

## Utilisation

- **D√©veloppement** : Utiliser les dossiers √† la racine
- **Audit** : Utiliser le dossier .project/
- **Documentation** : Consulter les README.md dans chaque dossier
"""
        
        guide_file = self.project_dir / "docs" / "PROJECT_ORGANIZATION_GUIDE.md"
        guide_file.parent.mkdir(exist_ok=True)
        
        with open(guide_file, 'w', encoding='utf-8') as f:
            f.write(guide_content)
        
        print(f"   üìÑ Guide g√©n√©r√©: {guide_file}")

def main():
    """Fonction principale."""
    project_dir = Path(__file__).parent
    
    print("üéØ AM√âLIORATION DE L'ORGANISATION DES PROJETS")
    print("=" * 60)
    print(f"üìÅ R√©pertoire: {project_dir}")
    print(f"‚è∞ Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()
    
    improver = ProjectOrganizationImprover(project_dir)
    
    # 1. Analyser la confusion actuelle
    issues = improver.analyze_current_confusion()
    
    # 2. Proposer une organisation claire
    improver.propose_clear_organization()
    
    # 3. R√©organiser les projets
    if issues:
        improver.reorganize_projects()
        
        # 4. V√©rifier l'am√©lioration
        improver.verify_improvement()
        
        # 5. G√©n√©rer un guide
        improver.generate_organization_guide()
        
        print("\nüéâ AM√âLIORATION TERMIN√âE")
        print("=" * 60)
        print("‚úÖ Organisation des projets am√©lior√©e!")
        print("üìã Guide g√©n√©r√© dans docs/PROJECT_ORGANIZATION_GUIDE.md")
    else:
        print("\n‚úÖ Organisation d√©j√† claire")
        print("Aucune am√©lioration n√©cessaire")

if __name__ == "__main__":
    main()
