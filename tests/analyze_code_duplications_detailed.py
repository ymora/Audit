#!/usr/bin/env python3
"""
ANALYSE D√âTAILL√âE DES DUPLICATIONS
===================================

Script pour analyser en d√©tail les duplications d√©tect√©es
et v√©rifier qu'elles ne proviennent pas du r√©pertoire codemort.
"""

import json
from pathlib import Path
import sys
from pathlib import Path

# Ajouter le r√©pertoire tools au path
current_dir = Path(__file__).parent
tools_dir = current_dir.parent / "tools"
sys.path.insert(0, str(tools_dir))

try:
    from code_analyzer import CodeAnalyzer
except ImportError:
    print("Erreur: Impossible d'importer CodeAnalyzer")
    print(f"Tools dir: {tools_dir}")
    print(f"Files in tools: {list(tools_dir.glob('*.py'))}")
    sys.exit(1)

def analyze_duplications_detailed():
    """Analyse d√©taill√©e des duplications."""
    print("üîç ANALYSE D√âTAILL√âE DES DUPLICATIONS")
    print("=" * 50)
    
    # Initialiser l'analyseur
    analyzer = CodeAnalyzer()
    
    # Analyser le projet
    print("üìä Analyse du projet en cours...")
    report = analyzer.analyze_project()
    
    # Afficher les statistiques
    print(f"\nüìà STATISTIQUES G√âN√âRALES:")
    print(f"   Fichiers analys√©s: {report['files_analyzed']}")
    print(f"   Fonctions totales: {report['total_functions']}")
    print(f"   Classes totales: {report['total_classes']}")
    print(f"   Duplications trouv√©es: {report['duplications_found']}")
    
    # Analyser les duplications
    print(f"\nüîç ANALYSE DES DUPLICATIONS:")
    print("-" * 30)
    
    if not report['duplications']:
        print("‚úÖ Aucune duplication d√©tect√©e!")
        return
    
    # Afficher le r√©sum√© des duplications
    summary = report.get('duplications_summary', {})
    print(f"\nüìä R√âSUM√â DES DUPLICATIONS:")
    print(f"   Total duplications: {summary.get('total_duplications', 0)}")
    print(f"   √Ä corriger: {summary.get('duplications_to_fix', 0)}")
    print(f"   L√©gitimes: {summary.get('legitimate_duplications', 0)}")
    print(f"   Critiques: {summary.get('critical_duplications', 0)}")
    print(f"   Moyennes: {summary.get('medium_duplications', 0)}")
    
    # Grouper par type de duplication
    duplications_to_fix = []
    legitimate_duplications = []
    codemort_duplications = []
    
    for dup in report['duplications']:
        function_name = dup['function_name']
        occurrences = dup['occurrences']
        dup_type = dup.get('type', 'unknown')
        severity = dup.get('severity', 'medium')
        recommendation = dup.get('recommendation', '')
        reason = dup.get('reason', '')
        
        print(f"\nüìã Fonction: {function_name}")
        print(f"   Type: {dup_type.upper()}")
        print(f"   Nombre d'occurrences: {dup['count']}")
        print(f"   S√©v√©rit√©: {severity}")
        
        if dup_type == 'to_fix':
            print(f"   üîß RECOMMANDATION: {recommendation}")
        elif dup_type == 'legitimate':
            print(f"   ‚úÖ RAISON: {reason}")
        
        for occ in occurrences:
            file_path = occ['file']
            print(f"   - {file_path}")
            
            # V√©rifier si c'est dans codemort
            if 'codemort' in file_path:
                codemort_duplications.append({
                    'function': function_name,
                    'file': file_path,
                    'type': dup_type,
                    'severity': severity
                })
            elif dup_type == 'to_fix':
                duplications_to_fix.append({
                    'function': function_name,
                    'file': file_path,
                    'severity': severity,
                    'recommendation': recommendation
                })
            else:
                legitimate_duplications.append({
                    'function': function_name,
                    'file': file_path,
                    'type': dup_type,
                    'reason': reason
                })
    
    # R√©sum√© final
    print(f"\nüìä R√âSUM√â FINAL:")
    print("=" * 30)
    print(f"   Total duplications: {len(report['duplications'])}")
    print(f"   √Ä corriger: {len(duplications_to_fix)}")
    print(f"   L√©gitimes: {len(legitimate_duplications)}")
    print(f"   Dans codemort: {len(codemort_duplications)}")
    
    if codemort_duplications:
        print(f"\n‚ö†Ô∏è  DUPLICATIONS DANS CODEMORT (PROBL√àME!):")
        for dup in codemort_duplications:
            print(f"   - {dup['function']} dans {dup['file']}")
    
    if duplications_to_fix:
        print(f"\nüîß DUPLICATIONS √Ä CORRIGER:")
        for dup in duplications_to_fix:
            print(f"   - {dup['function']} dans {dup['file']} ({dup['severity']})")
            print(f"     üí° {dup['recommendation']}")
    
    if legitimate_duplications:
        print(f"\n‚úÖ DUPLICATIONS L√âGITIMES:")
        for dup in legitimate_duplications:
            print(f"   - {dup['function']} dans {dup['file']} ({dup['reason']})")
    
    # Sauvegarder le rapport d√©taill√©
    detailed_report = {
        'summary': {
            'total_duplications': len(report['duplications']),
            'duplications_to_fix': len(duplications_to_fix),
            'legitimate_duplications': len(legitimate_duplications),
            'codemort_duplications': len(codemort_duplications)
        },
        'duplications_to_fix': duplications_to_fix,
        'legitimate_duplications': legitimate_duplications,
        'codemort_duplications': codemort_duplications,
        'all_duplications': report['duplications']
    }
    
    report_file = Path("reports/latest/detailed_duplications_analysis.json")
    with open(report_file, 'w', encoding='utf-8') as f:
        json.dump(detailed_report, f, indent=2, ensure_ascii=False)
    
    print(f"\nüíæ Rapport d√©taill√© sauvegard√©: {report_file}")

if __name__ == "__main__":
    analyze_duplications_detailed()
