#!/usr/bin/env python3
"""
MIGRATION VERS .PROJECT - SYST√àME D'AUDIT UNIVERSEL
==================================================

Script pour migrer de .project vers .project pour une structure plus claire.
"""

import os
import shutil
from pathlib import Path
from datetime import datetime

class ProjectMigrationManager:
    def __init__(self, project_dir: Path):
        self.project_dir = project_dir
        
    def analyze_migration_needs(self):
        """Analyse les besoins de migration."""
        print("üîç Analyse des besoins de migration...")
        
        migration_targets = []
        projects_dir = self.project_dir / "projects"
        
        if projects_dir.exists():
            for project_path in projects_dir.iterdir():
                if project_path.is_dir():
                    project_name = project_path.name
                    audit_dir = project_path / ".project"
                    
                    if audit_dir.exists():
                        migration_targets.append({
                            'project_name': project_name,
                            'project_path': project_path,
                            'audit_dir': audit_dir,
                            'project_dir': project_path / ".project"
                        })
                        print(f"   üìÅ {project_name}: Migration .project ‚Üí .project n√©cessaire")
        
        if not migration_targets:
            print("   ‚úÖ Aucune migration n√©cessaire")
        
        return migration_targets
    
    def backup_existing_structure(self, migration_targets):
        """Sauvegarde la structure existante."""
        print("\nüíæ Sauvegarde de la structure existante...")
        
        backup_dir = self.project_dir / "backup_migration"
        backup_dir.mkdir(exist_ok=True)
        
        for target in migration_targets:
            project_name = target['project_name']
            audit_dir = target['audit_dir']
            
            if audit_dir.exists():
                backup_path = backup_dir / f"{project_name}_audit_backup"
                print(f"   üì¶ Sauvegarde de {project_name}/.project vers {backup_path}")
                shutil.copytree(audit_dir, backup_path, dirs_exist_ok=True)
        
        print(f"   ‚úÖ Sauvegarde cr√©√©e dans: {backup_dir}")
        return backup_dir
    
    def migrate_to_project_structure(self, migration_targets):
        """Migre de .project vers .project."""
        print("\nüîÑ Migration vers la structure .project...")
        
        for target in migration_targets:
            project_name = target['project_name']
            audit_dir = target['audit_dir']
            project_dir = target['project_dir']
            
            print(f"   üìÅ Migration de {project_name}...")
            
            if audit_dir.exists():
                # Renommer .project en .project
                print(f"      üîÑ Renommage .project ‚Üí .project")
                shutil.move(str(audit_dir), str(project_dir))
                
                # Mettre √† jour les README
                self._update_project_readme(project_dir, project_name)
                
                # Cr√©er la structure claire
                self._create_clear_project_structure(project_dir, project_name)
                
                print(f"      ‚úÖ Migration termin√©e pour {project_name}")
    
    def _update_project_readme(self, project_dir: Path, project_name: str):
        """Met √† jour le README du dossier .project."""
        readme_file = project_dir / "README.md"
        
        readme_content = f"""# Dossier du Projet - {project_name}

Ce dossier contient tous les √©l√©ments sp√©cifiques au projet {project_name}.

## Structure :
- `config/` : Configuration du projet
- `logs/` : Logs du projet (historique, sessions, etc.)
- `reports/` : Rapports du projet (analyses, m√©triques, etc.)
- `tests/` : Tests du projet (int√©gration, performance, etc.)

## Distinction importante :
- Les logs/rapports du PROGRAMME sont dans les dossiers √† la racine
- Les logs/rapports du PROJET sont dans ce dossier .project/

## Utilisation :
Ce dossier est g√©r√© automatiquement par le syst√®me d'audit.
"""
        
        with open(readme_file, 'w', encoding='utf-8') as f:
            f.write(readme_content)
        
        print(f"      üìÑ README mis √† jour pour {project_name}")
    
    def _create_clear_project_structure(self, project_dir: Path, project_name: str):
        """Cr√©e une structure claire dans le dossier .project."""
        # Cr√©er les sous-dossiers s'ils n'existent pas
        for subdir in ["config", "logs", "reports", "tests"]:
            subdir_path = project_dir / subdir
            subdir_path.mkdir(exist_ok=True)
            
            # Cr√©er un README pour chaque sous-dossier
            readme_file = subdir_path / "README.md"
            
            if subdir == "config":
                content = f"""# Configuration du Projet - {project_name}

Ce dossier contient la configuration sp√©cifique au projet {project_name}.

## Contenu typique :
- project_config.json
- Param√®tres sp√©cifiques
- Configuration d'environnement
"""
            elif subdir == "logs":
                content = f"""# Logs du Projet - {project_name}

Ce dossier contient les logs du projet {project_name}.

## Contenu typique :
- Logs d'historique
- Logs de sessions
- Logs d'analyses
- Logs de m√©triques
"""
            elif subdir == "reports":
                content = f"""# Rapports du Projet - {project_name}

Ce dossier contient les rapports du projet {project_name}.

## Contenu typique :
- Rapports d'analyses
- Rapports de m√©triques
- Rapports de performance
- Rapports d'historique
"""
            elif subdir == "tests":
                content = f"""# Tests du Projet - {project_name}

Ce dossier contient les tests sp√©cifiques au projet {project_name}.

## Contenu typique :
- Tests d'int√©gration
- Tests de performance
- Tests sp√©cifiques au projet
- Tests d'analyse
"""
            
            with open(readme_file, 'w', encoding='utf-8') as f:
                f.write(content)
    
    def update_system_configuration(self):
        """Met √† jour la configuration du syst√®me pour utiliser .project."""
        print("\n‚öôÔ∏è Mise √† jour de la configuration du syst√®me...")
        
        # Mettre √† jour les scripts qui r√©f√©rencent .project
        self._update_audit_scripts()
        
        # Mettre √† jour la documentation
        self._update_documentation()
        
        print("   ‚úÖ Configuration du syst√®me mise √† jour")
    
    def _update_audit_scripts(self):
        """Met √† jour les scripts qui r√©f√©rencent .project."""
        print("      üîß Mise √† jour des scripts...")
        
        # Chercher les fichiers qui contiennent ".project"
        for file_path in self.project_dir.rglob("*.py"):
            if file_path.is_file():
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                    
                    if ".project" in content:
                        # Remplacer .project par .project
                        new_content = content.replace(".project", ".project")
                        
                        with open(file_path, 'w', encoding='utf-8') as f:
                            f.write(new_content)
                        
                        print(f"         üìù Mis √† jour: {file_path.relative_to(self.project_dir)}")
                except Exception as e:
                    print(f"         ‚ö†Ô∏è Erreur lors de la mise √† jour de {file_path}: {e}")
    
    def _update_documentation(self):
        """Met √† jour la documentation."""
        print("      üìÑ Mise √† jour de la documentation...")
        
        # Mettre √† jour le README principal
        readme_file = self.project_dir / "README.md"
        if readme_file.exists():
            try:
                with open(readme_file, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # Remplacer les r√©f√©rences √† .project
                new_content = content.replace(".project", ".project")
                
                with open(readme_file, 'w', encoding='utf-8') as f:
                    f.write(new_content)
                
                print("         üìù README.md mis √† jour")
            except Exception as e:
                print(f"         ‚ö†Ô∏è Erreur lors de la mise √† jour du README: {e}")
    
    def verify_migration(self, migration_targets):
        """V√©rifie que la migration s'est bien pass√©e."""
        print("\n‚úÖ V√©rification de la migration...")
        
        success_count = 0
        
        for target in migration_targets:
            project_name = target['project_name']
            project_dir = target['project_dir']
            old_audit_dir = target['audit_dir']
            
            # V√©rifier que .project existe
            if project_dir.exists():
                print(f"   ‚úÖ {project_name}: Dossier .project cr√©√©")
                
                # V√©rifier que .project n'existe plus
                if not old_audit_dir.exists():
                    print(f"   ‚úÖ {project_name}: Ancien dossier .project supprim√©")
                    
                    # V√©rifier la structure
                    for subdir in ["config", "logs", "reports", "tests"]:
                        subdir_path = project_dir / subdir
                        if subdir_path.exists():
                            print(f"   ‚úÖ {project_name}: Sous-dossier {subdir}/ cr√©√©")
                    
                    success_count += 1
                else:
                    print(f"   ‚ö†Ô∏è {project_name}: Ancien dossier .project toujours pr√©sent")
            else:
                print(f"   ‚ùå {project_name}: Dossier .project manquant")
        
        print(f"\nüìä R√©sultat: {success_count}/{len(migration_targets)} projets migr√©s avec succ√®s")
        return success_count == len(migration_targets)
    
    def generate_migration_report(self, migration_targets, backup_dir, success):
        """G√©n√®re un rapport de migration."""
        print("\nüìã G√©n√©ration du rapport de migration...")
        
        report_content = f"""# RAPPORT DE MIGRATION .AUDIT ‚Üí .PROJECT
Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## R√©sum√© de la migration

**Statut:** {'‚úÖ Succ√®s' if success else '‚ùå √âchec'}
**Projets migr√©s:** {len(migration_targets)}

## Projets trait√©s

"""
        
        for target in migration_targets:
            project_name = target['project_name']
            project_dir = target['project_dir']
            
            report_content += f"""### {project_name}
- **Ancien dossier:** .project
- **Nouveau dossier:** .project
- **Statut:** {'‚úÖ Migr√©' if project_dir.exists() else '‚ùå √âchec'}
- **Chemin:** {project_dir.relative_to(self.project_dir)}

"""
        
        report_content += f"""
## Sauvegarde

Une sauvegarde de l'ancienne structure a √©t√© cr√©√©e dans:
`{backup_dir.relative_to(self.project_dir)}`

## Nouvelle structure

```
projet_exemple/
‚îú‚îÄ‚îÄ config.json              # Configuration du projet
‚îú‚îÄ‚îÄ src/                     # Code source du projet
‚îú‚îÄ‚îÄ tests/                   # Tests du projet (fonctionnels, unitaires)
‚îú‚îÄ‚îÄ logs/                    # Logs du programme en cours d'ex√©cution
‚îú‚îÄ‚îÄ reports/                 # Rapports g√©n√©r√©s par le programme
‚îú‚îÄ‚îÄ docs/                    # Documentation du projet
‚îî‚îÄ‚îÄ .project/                # Dossier du projet (cach√©)
    ‚îú‚îÄ‚îÄ README.md           # Documentation du projet
    ‚îú‚îÄ‚îÄ config/              # Configuration du projet
    ‚îú‚îÄ‚îÄ logs/                # Logs du projet (historique, sessions)
    ‚îú‚îÄ‚îÄ reports/             # Rapports du projet (analyses, m√©triques)
    ‚îî‚îÄ‚îÄ tests/               # Tests du projet (int√©gration, performance)
```

## Avantages de la nouvelle structure

1. **Clart√©** : Plus de confusion entre programme et projet
2. **Intuitivit√©** : .project = tout ce qui concerne le projet
3. **Standard** : Conforme aux pratiques de l'industrie
4. **Maintenabilit√©** : Structure plus logique et coh√©rente

## Utilisation

- **D√©veloppement** : Utiliser les dossiers √† la racine
- **Projet** : Utiliser le dossier .project/
- **Documentation** : Consulter les README.md dans chaque dossier
"""
        
        report_file = self.project_dir / "docs" / "MIGRATION_REPORT.md"
        report_file.parent.mkdir(exist_ok=True)
        
        with open(report_file, 'w', encoding='utf-8') as f:
            f.write(report_content)
        
        print(f"   üìÑ Rapport g√©n√©r√©: {report_file}")

def main():
    """Fonction principale."""
    project_dir = Path(__file__).parent
    
    print("üéØ MIGRATION VERS .PROJECT - SYST√àME D'AUDIT UNIVERSEL")
    print("=" * 60)
    print(f"üìÅ R√©pertoire: {project_dir}")
    print(f"‚è∞ Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()
    
    migrator = ProjectMigrationManager(project_dir)
    
    # 1. Analyser les besoins de migration
    migration_targets = migrator.analyze_migration_needs()
    
    if not migration_targets:
        print("‚úÖ Aucune migration n√©cessaire")
        return
    
    # 2. Sauvegarder la structure existante
    backup_dir = migrator.backup_existing_structure(migration_targets)
    
    # 3. Migrer vers la structure .project
    migrator.migrate_to_project_structure(migration_targets)
    
    # 4. Mettre √† jour la configuration du syst√®me
    migrator.update_system_configuration()
    
    # 5. V√©rifier la migration
    success = migrator.verify_migration(migration_targets)
    
    # 6. G√©n√©rer un rapport
    migrator.generate_migration_report(migration_targets, backup_dir, success)
    
    print("\nüéâ MIGRATION TERMIN√âE")
    print("=" * 60)
    if success:
        print("‚úÖ Migration vers .project r√©ussie!")
        print("üìã Rapport g√©n√©r√© dans docs/MIGRATION_REPORT.md")
        print("üíæ Sauvegarde cr√©√©e dans backup_migration/")
    else:
        print("‚ùå Migration partiellement √©chou√©e")
        print("üìã Consultez le rapport pour plus de d√©tails")

if __name__ == "__main__":
    main()
